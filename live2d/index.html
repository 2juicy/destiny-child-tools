<!DOCTYPE html>
<html>
<head>
	<title>Destiny Child Live2D Viewer</title>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script
    src="https://code.jquery.com/ui/1.12.0/jquery-ui.min.js"
    integrity="sha256-eGE6blurk5sHj+rmkfsGYeKyZx3M4bG+ZlFyA7Kns7E="
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<style type="text/css">
  	pre {
      border: 1px solid #666;
      background: #ccc;
      padding: 1em;
      text-align: left;
    }
    .custom-combobox-toggle {
      height: 1.7em;
      margin-top: -0.2em;
      margin-left: -1px;
    }
    .custom-combobox-input {
      padding: .2em .5em;
    }
	</style>
  <script type="application/javascript">
    function setViewer(model) {
      var viewer = document.getElementsByTagName('iframe')[0]
      viewer.src = 'viewer.html?mN=' + model
      var code = viewer.outerHTML.replace('viewer.html', document.location.toString() + 'viewer.html')
      var embed = document.getElementById('embed').innerHTML = code.replace(/</g, '&lt;')
      console.log(code, )
    }
    function init() {
      setViewer('c001_01')
      $.getJSON('../data/childs.json', function(childs) {
        $('option').each(function(i, option) {
          var parts = option.value.split('_'),
              child = childs[parts[0]],
              v = parts[1],
              variant = child && child.variants[v]
          console.log(v);

          if(child) {
            option.innerHTML += ' '+ (
              (variant && variant.name)
                ? variant.name
                : child.name + ' ' + (v == '00' ? 'Story'
                  : v == '01' ? 'E-A Class'
                    : v == '02' ? 'S Class'
                      : 'Special'
                )
            )
          }
        })





        $.widget('custom.combobox', {
          _create: function() {
            this.wrapper = $('<span>')
              .addClass('custom-combobox')
              .insertAfter( this.element );

            this.element.hide();
            this._createAutocomplete();
            this._createShowAllButton();
          },

          _createAutocomplete: function() {
            var selected = this.element.children(':selected'),
              value = selected.val() ? selected.text() : "";

            this.input = $('<input>')
              .appendTo( this.wrapper )
              .val( value )
              .attr('title', '')
              .addClass('custom-combobox-input ui-widget ui-widget-content ui-state-default ui-corner-left')
              .autocomplete({
                delay: 0,
                minLength: 0,
                source: $.proxy( this, '_source')
              })
              .tooltip({
                classes: {
                  "ui-tooltip": "ui-state-highlight"
                }
              });

            this._on( this.input, {
              autocompleteselect: function( event, ui ) {
                ui.item.option.selected = true;
                this._trigger('select', event, {
                  item: ui.item.option
                });
              },

              autocompletechange: "_removeIfInvalid"
            });
          },

          _createShowAllButton: function() {
            var input = this.input,
              wasOpen = false;

            $('<a>')
              .attr('tabIndex', -1 )
              .attr('title', 'Show All Items')
              .tooltip()
              .appendTo( this.wrapper )
              .button({
                icons: {
                  primary: "ui-icon-triangle-1-s"
                },
                text: false
              })
              .removeClass('ui-corner-all')
              .addClass('custom-combobox-toggle ui-corner-right')
              .on('mousedown', function() {
                wasOpen = input.autocomplete('widget').is(':visible');
              })
              .on('click', function() {
                input.trigger('focus');

                // Close if already visible
                if ( wasOpen ) {
                  return;
                }

                // Pass empty string as value to search for, displaying all results
                input.autocomplete('search', '');
              });
          },

          _source: function( request, response ) {
            var matcher = new RegExp( $.ui.autocomplete.escapeRegex(request.term), 'i');
            response( this.element.children('option').map(function() {
              var text = $( this ).text();
              if ( this.value && ( !request.term || matcher.test(text) ) )
                return {
                  label: text,
                  value: text,
                  option: this
                };
            }) );
          },

          _removeIfInvalid: function( event, ui ) {

            // Selected an item, nothing to do
            if ( ui.item ) {
              return;
            }

            // Search for a match (case-insensitive)
            var value = this.input.val(),
              valueLowerCase = value.toLowerCase(),
              valid = false;
            this.element.children('option').each(function() {
              if ( $( this ).text().toLowerCase() === valueLowerCase ) {
                this.selected = valid = true;
                return false;
              }
            });

            // Found a match, nothing to do
            if ( valid ) {
              return;
            }

            // Remove invalid value
            this.input
              .val('')
              .attr('title', value + ' didn\'t match any item')
              .tooltip('open');
            this.element.val('');
            this._delay(function() {
              this.input.tooltip('close').attr('title', '');
            }, 2500 );
            this.input.autocomplete('instance').term = "";
          },

          _destroy: function() {
            this.wrapper.remove();
            this.element.show();
          }
        });

        $('select').combobox({
          select: function() { setViewer(this.value)}
        });
      })
    }
  </script>
</head>
<body onload="init()">
  <p>Live2D viewer based on work by Arsylk using Live2D cubism v2 api</p>
  <p>Select model:
    <select onchange="setViewer(this.value)">
      <option value="c001_01">c001_01</option>
      <option value="c001_02">c001_02</option>
      <option value="c001_12">c001_12</option>
      <option value="c001_14">c001_14</option>
      <option value="c002_00">c002_00</option>
      <option value="c002_01">c002_01</option>
      <option value="c002_02">c002_02</option>
      <option value="c002_10">c002_10</option>
      <option value="c002_11">c002_11</option>
      <option value="c002_12">c002_12</option>
    </select>
    Embed code:
  </p>
  <pre id="embed"></pre>
  <iframe src="viewer.html?mN=c001_01" style="width: 100%; height: 700px; border: none;"></iframe>


</html>
